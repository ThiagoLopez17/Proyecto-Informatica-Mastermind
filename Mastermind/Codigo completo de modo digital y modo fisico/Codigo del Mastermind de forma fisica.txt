#include <Adafruit_NeoPixel.h>
#include <LiquidCrystal.h>

// ------------------------------
// PINES
// ------------------------------
#define PIN_NEOPIXEL 3
#define NUM_PIXELS 64

#define PIN_CLK 9
#define PIN_DT 10
#define PIN_SW 11
#define PIN_BUZZER 6

Adafruit_NeoPixel matriz(NUM_PIXELS, PIN_NEOPIXEL, NEO_GRB + NEO_KHZ800);
LiquidCrystal lcd(13, 12, 8, 7, 4, 2);

// ------------------------------
// COLORES
// ------------------------------
const char* nombresColores[] = {
  "Rojo", "Verde", "Azul", "Amarillo",
  "Morado", "Celeste", "Blanco", "Naranja"
};

uint32_t valoresColores[] = {
  Adafruit_NeoPixel::Color(255, 0, 0),
  Adafruit_NeoPixel::Color(0, 255, 0),
  Adafruit_NeoPixel::Color(0, 0, 255),
  Adafruit_NeoPixel::Color(255, 255, 0),
  Adafruit_NeoPixel::Color(150, 0, 200),
  Adafruit_NeoPixel::Color(0, 255, 255),
  Adafruit_NeoPixel::Color(255, 255, 255),
  Adafruit_NeoPixel::Color(255, 120, 0)
};

const int CANT_COLORES = 8;
int codigoSecreto[8];

// ------------------------------
// BUZZER
// ------------------------------
void beepConfirm() {
  tone(PIN_BUZZER, 900, 120);
}

void beepError() {
  tone(PIN_BUZZER, 200, 350);
  delay(350);
}

void beepWin() {
  tone(PIN_BUZZER, 900, 150);
  delay(160);
  tone(PIN_BUZZER, 1200, 200);
  delay(220);
  tone(PIN_BUZZER, 1500, 250);
  delay(260);
}

void beepLose() {
  for (int i = 0; i < 3; i++) {
    tone(PIN_BUZZER, 180, 300);
    delay(350);
  }
}

// ------------------------------
// ENCODER — LECTURA
// ------------------------------
int ultimoCLK = HIGH;
int colorActual = 0;

int leerEncoder() {
  int estadoCLK = digitalRead(PIN_CLK);
  int estadoDT = digitalRead(PIN_DT);

  if (estadoCLK != ultimoCLK && estadoCLK == LOW) {

    if (estadoDT != estadoCLK) {
      colorActual++;        // GIRA DERECHA
    } else {
      colorActual--;        // GIRA IZQUIERDA
    }

    if (colorActual < 0) colorActual = CANT_COLORES - 1;
    if (colorActual >= CANT_COLORES) colorActual = 0;
  }

  ultimoCLK = estadoCLK;
  return colorActual;
}

// Esperar la pulsación del botón SW
void esperarConfirmacion() {
  while (digitalRead(PIN_SW) == HIGH); // espera presionar
  delay(250);
  while (digitalRead(PIN_SW) == LOW);  // espera soltar
  delay(200);
}

// ------------------------------
// MATRIZ
// ------------------------------
void setFilaColor(int fila, int pos, uint32_t color) {
  matriz.setPixelColor(fila * 8 + pos, color);
  matriz.show();
}

void limpiarFila(int fila) {
  for (int i = 0; i < 8; i++) {
    matriz.setPixelColor(fila * 8 + i, 0);
  }
  matriz.show();
}

// ------------------------------
// CODIGO SECRETO
// ------------------------------
void generarCodigo() {
  for (int i = 0; i < 8; i++) {
    codigoSecreto[i] = random(CANT_COLORES);
  }
}

// ------------------------------
// MOSTRAR ACIERTOS EXACTOS
// ------------------------------
void mostrarAciertos(int intento[], int fila) {
  int aciertos = 0;

  for (int i = 0; i < 8; i++) {
    if (intento[i] == codigoSecreto[i]) aciertos++;
  }

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Intento ");
  lcd.print(fila + 1);

  lcd.setCursor(0, 1);
  lcd.print("Aciertos: ");
  lcd.print(aciertos);

  beepConfirm();
  delay(1200);

  if (aciertos == 8) {
    beepWin();
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("  GANASTE!!!");
    lcd.setCursor(0, 1);
    lcd.print("Perfecto :)");
    while (1);
  }
}

// ------------------------------
// SETUP
// ------------------------------
void setup() {
  pinMode(PIN_CLK, INPUT);
  pinMode(PIN_DT, INPUT);
  pinMode(PIN_SW, INPUT_PULLUP);
  pinMode(PIN_BUZZER, OUTPUT);

  matriz.begin();
  matriz.clear();
  matriz.show();

  lcd.begin(16, 2);

  randomSeed(analogRead(A1));

  lcd.setCursor(0, 0);
  lcd.print("Mastermind 8x8");
  lcd.setCursor(0, 1);
  lcd.print("Presione SW");

  esperarConfirmacion();
  generarCodigo();

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Codigo listo!");
  delay(1200);
}

// ------------------------------
// LOOP PRINCIPAL
// ------------------------------
void loop() {

  int intento[8];

  for (int fila = 0; fila < 8; fila++) {

    limpiarFila(fila);

    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Intento ");
    lcd.print(fila + 1);

    for (int pos = 0; pos < 8; pos++) {

      while (digitalRead(PIN_SW) == HIGH) {

        int c = leerEncoder();
        intento[pos] = c;

        setFilaColor(fila, pos, valoresColores[c]);

        lcd.setCursor(0, 1);
        lcd.print("Color: ");
        lcd.print(nombresColores[c]);
        lcd.print("   ");

        delay(30);
      }

      beepConfirm();
      esperarConfirmacion();
    }

    mostrarAciertos(intento, fila);
  }

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Perdiste :(");
  lcd.setCursor(0, 1);
  lcd.print("Sin intentos");

  beepLose();
  while (1);
}
